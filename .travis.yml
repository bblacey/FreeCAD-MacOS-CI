sudo: disabled
language: cpp

os:
- osx

git:
  depth: 800

before_install:
- system_profiler SPHardwareDataType
- brew update
- brew tap homebrew/science
- brew tap sanelson/freecad
- brew install eigen freetype qt homebrew/science/oce python boost-python pyside pyside-tools xerces-c orocos-kdl libspnav
- brew install --without-framework --without-soqt sanelson/freecad/coin
- brew install --HEAD pivy
- brew install homebrew/python/matplotlib
- if [ -e /usr/local/lib/libgdal.1.dylib ]; then brew unlink gdal; fi

install:
- mkdir build && cd build && cmake -DFREECAD_USE_EXTERNAL_KDL=ON -DFREECAD_CREATE_MAC_APP=ON -DCMAKE_BUILD_TYPE=Release ../

script:
- make -j2
- bin/FreeCAD --run-test 0
- bin/FreeCAD --log-file /tmp/FreeCAD.log &
- sleep 10 && pkill FreeCAD
- cat /tmp/FreeCAD.log
- grep --file=../.log_errors /tmp/FreeCAD.log ; [ $? == 1 ] && echo "No errors from .log_errors file found in the log after start from build directory" || ( echo "Error from .log_errors found!" && false )
- make install/fast
- /usr/local/FreeCAD.app/Contents/bin/FreeCAD --run-test 0
- /usr/local/FreeCAD.app/Contents/bin/FreeCAD --log-file /tmp/FreeCAD_installed.log &
- sleep 10 && pkill FreeCAD
- cat /tmp/FreeCAD_installed.log
- grep --file=../.log_errors /tmp/FreeCAD_installed.log ; [ $? == 1 ] && echo "No errors from .log_errors file found in the log after start from /usr/local/bin" || ( echo "Error from .log_errors found!" && false )

before_deploy:
- export MASTER_COMMIT=$(git ls-remote origin | grep 'refs/heads/master' | cut -f1)
- #export VSN=$(sed -E -n -e 's/(^#define FCRevision.*")([0-9]+)(.*Git.*$)/\2/p' ${TRAVIS_BUILD_DIR}/build/src/Build/Version.h)-${TRAVIS_COMMIT:0:7}
- export VSN=$(sed -E -n -e 's/(^#define FCRevision.*")([0-9]+)(.*Git.*$)/\2/p' ${TRAVIS_BUILD_DIR}/build/src/Build/Version.h)-${MASTER_COMMIT:0:7}
- echo "Version = $VSN"
- export DEPLOYMENT_ARCHIVE="FreeCAD_osx-${VSN}.zip"
- cd /usr/local && zip -q -r -X "${DEPLOYMENT_ARCHIVE}" FreeCAD.app -x FreeCAD.app/Contents/doc\*
- #cd /usr/local && tar -cz --exclude '*/doc/*' -f "${DEPLOYMENT_ARCHIVE}" FreeCAD.app

deploy:
  provider: releases
  api_key:
    secure: DlnEwU6+O3vt2mAy0lvD5qhsw8p4yo3eIpH6xRqU5goKfUYXWLU7h/+C2MQsyof6mD2ZPrHH7PHgwBdif2lcIy3aRDc+F3ocSQBEQcjm+FEq/vLNb3QR5q+k/sLl0u+Va/TamU/KLlTIRpDelWL/9Ik5NaGR7nvxkFw6a8fAkS1cTbqwMpPCtuju+Uv6Ahs7peYRkAVbalJ82oP3651pinHJKgljhY76+35IJS2H5mr2biFTGFBX/lnvfSxbhM5kKvJWBuYX3VWEuXcNE3o86itswruLEV4krJcyU6TUr8KA+uPBVgkf0TFQyPW1t7c6UH4KLSmqP8AmcfO+qzj2Ex+FqFNCubLyXHkED4Yss2OnxLh2J6sxzEyHhE5UXHHUAvOgeYATtMcQ9K6nHdUtIBoga14HMURJkcdQMel0Wc6t18MZrJnnzykzmqOVNpg1f1AcPcE0ZkLzaFA34Kq04DoHEB2LOscIAuC+sbXPHkb6cdycz5qP80a1VNMpek5QZgmjHhp1Vi2PdlMEl+ezp9e/QLfHjo4Yge98EtkiaiXH1DKARkJlKFXQL9OKKovnQtNRcvJhCUGymgTXXaBomyk6U0DWak8AONj7DYwtnVfFlBZ10TgCd+0oNuLtni9k64xc13aI224i0Y3BDrgn62ycAvha8Ecmn5nWbkzSva8=
  file: "/usr/local/${DEPLOYMENT_ARCHIVE}"
  on:
    repo: bblacey/FreeCAD-MacOS-CI
    all_branches: true
    tags: true

after_script:
- if [ ${TRAVIS_TEST_RESULT} == 0 ]; then export MSG="SUCCEEDED"; else export MSG="FAILED"; fi
- curl -s --form-string "token=${PO_APP}" --form-string "user=${PO_USER}" --form-string "html=1" --form-string 
  "message=FreeCAD OS X build ${VSN} <b>${MSG}</b> (${TAVIS_REPO_SLUG}#${TRAVIS_BUILD_NUMBER})</b><br> 
  <a href=\"https://api.travis-ci.org/jobs/${TRAVIS_JOB_ID}/log.txt?deansi=true\">Build ${TRAVIS_BUILD_NUMBER} Log</a><br>
  <a href=\"https://github.com/bblacey/FreeCAD-MacOS-CI/releases/tag/${TRAVIS_COMMIT}\">Download build ${VSN} from GitHub</a>"
  https://api.pushover.net/1/messages.json

env:
  global:
  - secure: exhWNlrsAbxghGG9cVblAVtJAPP9ZvlHflap9mBGgl0D3nSXDMtNESYHsIDI5v22Pl02SORTtQNc308ttk/7dFRJXr8DKKBfDvPkXV/j9KnA+TOu3dOQuqHMR2TRsFyfDeyLMCOazlYZMfryZCsf8EuUnF3TNLeHXcPxDveJPZ5vEnuveJcZmr57g+pS8POJnuM5X6VzrrmA4PGVKzwnWztNGoETi4iES9/61bB35jnllNdBi0R63QmbTzLvrSLCjPxOwjeymQbpqnxDDYOuXUPdtU5RrjvX1jzFCHbaJWtHvi45t26ufX7e1ob4tplFoX14fRzrQYiE2557x7AN18UJsIOrQ30OO+W78rk8feUamsVNyOeo6jnHoi4AeUPShoZ3dt42Z5dQ20rWoD0amqapIry7EORzrUIsgUHRATIypa/kVYlf2pVmQ930LelWlEtiLHPXuviaWeSPmipXkQi0mZY96X3C/fy+LzrpNrQJsK0ucUlM46SVUUWOHtO+OK8WyT7OiQaGsAa3OhRVaql21gM/X8uA9P0OB/Rdag3SEkZlpNjAn6qcqNgopGDGfEOyqC4f17YDeHQGWad12tygC/y29el3Xzi5Rm9J9zeMdJ7K+EPSqhwqnbeos8pSDCBeY2XHF0fzjih1BABNxopSVDdk4+Opl7zWBRHmxm8=
  - secure: egFL2wg8DAhkl7MzyU/hrx3J/pwsvoOfz4CWDP5UJnzNkeXAma9Wpdk1+0UtOzlwKZ0tziKe1+6JpHAcHTgLY/SR4XUs0+7Jkc+igQOsa6OmxFfcnUSfxU/mhtpzfNIdq+cxNGN0vYuvK3KAfkE07qdbUF/ZJmhlFqVa1kRBpci2KYxcF0599aeWmcQpoLePHWUuujlbYEiLHF5rrhZeeWULafiNlW97RWynurpgjM/Om7r9BUd6BUR9xQhBQ5FzsN5PASSdjZjD2qjMLnbCF8k71CO1HkvA9PN8VWK3FEddsgA32livf+zE9RvlbDaZq2QmXgSVPMy5Hmi5Q2SiBn3s+f1hoLnXj/vJdA/vnIJzO1F8mN2Ykd0H8/aINVWr2nM3FglGTrD1bv3It1yqA/EKH1vZbQTEp/goV1ehjg49U8+WD3a5UVr6nh3trec69nqN+XlYGTTQoQa58JNy/uticZiytQgG3w+V7vCzmgVL6m+ZCvLLjZ79S5Ebh9JNNYX9DMkEVPQrPPpwpyTa5EAEZkgzHbktpVEVacfITIRhbtKJXKJ1mhmEnVTN4Wp1BQUoQEVTx685ih/wXvphtmBj1Pr0d2mxVA++1g7v8HKAxLalQ9wJ9Ss7YnCMEvShaAMc/Me6RGTuwhpDcUS5hQCOU9aTupT5yVottNDEBMs=

